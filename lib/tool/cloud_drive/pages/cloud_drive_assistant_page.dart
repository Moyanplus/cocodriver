import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:flutter_screenutil/flutter_screenutil.dart';

import '../../../../core/logging/log_manager.dart';
import '../../../../core/utils/responsive_utils.dart';
import '../../../../shared/widgets/common/bottom_sheet_widget.dart';
import '../../../../shared/widgets/common/common_widgets.dart';
import '../config/cloud_drive_ui_config.dart';
import 'cloud_drive_account_detail_page.dart';
import 'cloud_drive_widgets.dart';
import '../base/cloud_drive_operation_service.dart';
import '../models/cloud_drive_models.dart';
import '../providers/cloud_drive_provider.dart';
import '../widgets/add_account_form_widget.dart';

/// ‰∫ëÁõòÂä©ÊâãÈ°µÈù¢
class CloudDriveAssistantPage extends ConsumerStatefulWidget {
  const CloudDriveAssistantPage({super.key});

  @override
  ConsumerState<CloudDriveAssistantPage> createState() =>
      _CloudDriveAssistantPageState();
}

class _CloudDriveAssistantPageState
    extends ConsumerState<CloudDriveAssistantPage> {
  @override
  void initState() {
    super.initState();
    // Âä†ËΩΩÂàùÂßãÊï∞ÊçÆ
    WidgetsBinding.instance.addPostFrameCallback((_) {
      ref.read(cloudDriveProvider.notifier).loadAccounts();
    });
  }

  @override
  Widget build(BuildContext context) {
    final state = ref.watch(cloudDriveProvider);

    return Scaffold(
      backgroundColor: Theme.of(context).colorScheme.surface,
      body:
          state.accounts.isEmpty && !state.isLoading
              ? Center(
                child: CommonWidgets.buildEmptyState(
                  message: 'ÊöÇÊó†‰∫ëÁõòË¥¶Âè∑',
                  onAction: _handleAddAccount,
                  actionText: 'Ê∑ªÂä†Ë¥¶Âè∑',
                ),
              )
              : const CloudDriveWidget(),
      // Ê∑ªÂä†ÊÇ¨ÊµÆÊåâÈíÆ
      floatingActionButton: _buildFloatingActionButton(state),
    );
  }

  /// Â§ÑÁêÜÊ∑ªÂä†Ë¥¶Âè∑
  void _handleAddAccount() {
    BottomSheetWidget.showWithTitle(
      context: context,
      title: 'Ê∑ªÂä†‰∫ëÁõòË¥¶Âè∑',
      content: AddAccountFormWidget(
        onAccountCreated: (account) async {
          try {
            await ref.read(cloudDriveProvider.notifier).addAccount(account);
            Navigator.pop(context);
            _showAccountAddSuccess(account.name);
          } catch (e) {
            _showAccountAddError(e);
          }
        },
        onCancel: () => Navigator.pop(context),
      ),
    );
  }

  /// Â§ÑÁêÜË¥¶Âè∑ÁÇπÂáª
  void _handleAccountTap(CloudDriveAccount account) {
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => CloudDriveAccountDetailPage(account: account),
      ),
    );
  }

  Widget _buildFloatingActionButton(CloudDriveState state) {
    // Â¶ÇÊûúÊúâÂæÖÊìç‰ΩúÁöÑÊñá‰ª∂ÔºåÊòæÁ§∫Â§çÂà∂/ÁßªÂä®ÊåâÈíÆ
    if (state.showFloatingActionButton && state.pendingOperationFile != null) {
      final file = state.pendingOperationFile!;
      final operationType = state.pendingOperationType;

      return FloatingActionButton.extended(
        onPressed: () async {
          final notifier = ref.read(cloudDriveProvider.notifier);

          LogManager().cloudDrive('üéØ ÊÇ¨ÊµÆÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂ÂºÄÂßã');
          LogManager().cloudDrive('üìÑ ÂæÖÊìç‰ΩúÊñá‰ª∂: ${file.name}');
          LogManager().cloudDrive('üîß Êìç‰ΩúÁ±ªÂûã: ${operationType}');
          LogManager().cloudDrive(
            'üë§ ÂΩìÂâçË¥¶Âè∑: ${state.currentAccount?.name ?? 'null'}',
          );

          LogManager().cloudDrive('‚úÖ ÂèÇÊï∞È™åËØÅÈÄöËøáÔºåÂºÄÂßãÊâßË°åÊìç‰Ωú');

          try {
            // ÊâßË°åÊìç‰Ωú
            LogManager().cloudDrive('üöÄ Ë∞ÉÁî® executePendingOperation');
            final success = await notifier.executePendingOperation();
            LogManager().cloudDrive(
              '‚úÖ executePendingOperation ÊâßË°åÂÆåÊàêÔºåÁªìÊûú: $success',
            );

            // Ê†πÊçÆÊìç‰ΩúÁªìÊûúÊòæÁ§∫‰∏çÂêåÁöÑÊèêÁ§∫
            if (mounted) {
              if (success) {
                LogManager().cloudDrive('üì± ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫ SnackBar');
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(
                      'Êñá‰ª∂${operationType == 'copy' ? 'Â§çÂà∂' : 'ÁßªÂä®'}ÊàêÂäü: ${file.name}',
                    ),
                    backgroundColor: CloudDriveUIConfig.successColor,
                    duration: const Duration(seconds: 3),
                  ),
                );
                LogManager().cloudDrive('‚úÖ ÊàêÂäü SnackBar ÊòæÁ§∫ÂÆåÊàê');
              } else {
                LogManager().cloudDrive('üì± ÊòæÁ§∫Â§±Ë¥•ÊèêÁ§∫ SnackBar');
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(
                      'Êñá‰ª∂${operationType == 'copy' ? 'Â§çÂà∂' : 'ÁßªÂä®'}Â§±Ë¥•: ${file.name}',
                    ),
                    backgroundColor: CloudDriveUIConfig.errorColor,
                    duration: const Duration(seconds: 3),
                  ),
                );
                LogManager().cloudDrive('‚úÖ Â§±Ë¥• SnackBar ÊòæÁ§∫ÂÆåÊàê');
              }
            } else {
              LogManager().cloudDrive('‚ö†Ô∏è Widget Â∑≤Âç∏ËΩΩÔºåÊó†Ê≥ïÊòæÁ§∫ SnackBar');
            }
          } catch (e) {
            LogManager().error('‚ùå ÊâßË°åÊìç‰ΩúÊó∂ÂèëÁîüÂºÇÂ∏∏', exception: e);
            if (mounted) {
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text('Êìç‰ΩúÂºÇÂ∏∏: $e'),
                  backgroundColor: CloudDriveUIConfig.errorColor,
                  duration: const Duration(seconds: 3),
                ),
              );
            }
          }

          LogManager().cloudDrive('üéØ ÊÇ¨ÊµÆÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂ÁªìÊùü');
        },
        icon: Icon(
          state.pendingOperationType == 'copy'
              ? Icons.copy
              : Icons.drive_file_move,
          color: CloudDriveUIConfig.backgroundColor,
        ),
        label: Text(
          state.pendingOperationType == 'copy' ? 'Â§çÂà∂Âà∞ËøôÈáå' : 'ÁßªÂä®Âà∞ËøôÈáå',
          style: TextStyle(color: CloudDriveUIConfig.backgroundColor),
        ),
        backgroundColor:
            state.pendingOperationType == 'copy'
                ? CloudDriveUIConfig.infoColor
                : CloudDriveUIConfig.warningColor,
      );
    }

    // ÈªòËÆ§ÊòæÁ§∫ÂàõÂª∫Êñá‰ª∂Â§πÂíå‰∏ä‰º†ÊåâÈíÆ
    return FloatingActionButton(
      onPressed: () => _showActionMenu(context),
      tooltip: 'Êõ¥Â§öÊìç‰Ωú',
      child: const Icon(Icons.add),
    );
  }

  void _showActionMenu(BuildContext context) {
    final state = ref.read(cloudDriveProvider);
    final currentAccount = state.currentAccount;

    // Â¶ÇÊûúÊ≤°ÊúâÂΩìÂâçË¥¶Âè∑ÔºåÊòæÁ§∫ÊèêÁ§∫
    if (currentAccount == null) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('ËØ∑ÂÖàÈÄâÊã©‰∫ëÁõòË¥¶Âè∑'),
          backgroundColor: CloudDriveUIConfig.warningColor,
          duration: Duration(seconds: 2),
        ),
      );
      return;
    }

    // Ê£ÄÊü•ÊîØÊåÅÁöÑÊìç‰Ωú
    final supportsCreateFolder =
        CloudDriveOperationService.isOperationSupported(
          currentAccount,
          'createFolder',
        );

    // ‰ΩøÁî®ÂìçÂ∫îÂºèÂ∫ïÈÉ®ÂºπÁ™ó
    BottomSheetWidget.show(
      context: context,
      title: 'Êõ¥Â§öÊìç‰Ωú',
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          // ÂàõÂª∫Êñá‰ª∂Â§πÈÄâÈ°π
          if (supportsCreateFolder) ...[
            _buildResponsiveListTile(
              context: context,
              icon: Icons.create_new_folder,
              title: 'ÂàõÂª∫Êñá‰ª∂Â§π',
              onTap: () {
                Navigator.pop(context);
                _showCreateFolderDialog(context);
              },
            ),
          ] else ...[
            _buildResponsiveListTile(
              context: context,
              icon: Icons.create_new_folder,
              title: 'ÂàõÂª∫Êñá‰ª∂Â§πÔºàÊöÇ‰∏çÊîØÊåÅÔºâ',
              enabled: false,
            ),
          ],
          // ‰∏ä‰º†Êñá‰ª∂ÈÄâÈ°πÔºàÊöÇÊó∂ÈÉΩ‰∏çÊîØÊåÅÔºâ
          _buildResponsiveListTile(
            context: context,
            icon: Icons.upload_file,
            title: '‰∏ä‰º†Êñá‰ª∂ÔºàÂºÄÂèë‰∏≠Ôºâ',
            enabled: false,
          ),
        ],
      ),
    );
  }

  void _showCreateFolderDialog(BuildContext context) {
    final TextEditingController controller = TextEditingController();

    showDialog(
      context: context,
      builder:
          (BuildContext context) => AlertDialog(
            backgroundColor: Theme.of(context).colorScheme.surface,
            shape: RoundedRectangleBorder(
              borderRadius: BorderRadius.circular(
                ResponsiveUtils.getCardRadius(),
              ),
            ),
            title: Text(
              'ÂàõÂª∫Êñá‰ª∂Â§π',
              style: Theme.of(context).textTheme.titleLarge?.copyWith(
                color: Theme.of(context).colorScheme.onSurface,
                fontSize: ResponsiveUtils.getResponsiveFontSize(20.sp),
              ),
            ),
            content: Container(
              width: ResponsiveUtils.getMaxWidth() * 0.8,
              child: TextField(
                controller: controller,
                style: TextStyle(
                  color: Theme.of(context).colorScheme.onSurface,
                  fontSize: ResponsiveUtils.getResponsiveFontSize(16.sp),
                ),
                decoration: InputDecoration(
                  labelText: 'Êñá‰ª∂Â§πÂêçÁß∞',
                  hintText: 'ËØ∑ËæìÂÖ•Êñá‰ª∂Â§πÂêçÁß∞',
                  labelStyle: TextStyle(
                    color: Theme.of(context).colorScheme.onSurfaceVariant,
                    fontSize: ResponsiveUtils.getResponsiveFontSize(14.sp),
                  ),
                  hintStyle: TextStyle(
                    color: Theme.of(
                      context,
                    ).colorScheme.onSurfaceVariant.withOpacity(0.5),
                    fontSize: ResponsiveUtils.getResponsiveFontSize(14.sp),
                  ),
                  border: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8.r),
                    borderSide: BorderSide(
                      color: Theme.of(context).colorScheme.outline,
                    ),
                  ),
                  enabledBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8.r),
                    borderSide: BorderSide(
                      color: Theme.of(context).colorScheme.outline,
                    ),
                  ),
                  focusedBorder: OutlineInputBorder(
                    borderRadius: BorderRadius.circular(8.r),
                    borderSide: BorderSide(
                      color: Theme.of(context).colorScheme.primary,
                      width: 2.w,
                    ),
                  ),
                  contentPadding: ResponsiveUtils.getResponsivePadding(
                    horizontal: 16.w,
                    vertical: 12.h,
                  ),
                ),
                autofocus: true,
              ),
            ),
            actions: [
              TextButton(
                onPressed: () => Navigator.pop(context),
                style: TextButton.styleFrom(
                  padding: ResponsiveUtils.getResponsivePadding(
                    horizontal: 16.w,
                    vertical: 8.h,
                  ),
                ),
                child: Text(
                  'ÂèñÊ∂à',
                  style: TextStyle(
                    color: Theme.of(context).colorScheme.primary,
                    fontSize: ResponsiveUtils.getResponsiveFontSize(16.sp),
                  ),
                ),
              ),
              ElevatedButton(
                onPressed: () {
                  final folderName = controller.text.trim();
                  if (folderName.isNotEmpty) {
                    Navigator.pop(context);
                    _createFolder(folderName);
                  }
                },
                style: ElevatedButton.styleFrom(
                  backgroundColor: Theme.of(context).colorScheme.primary,
                  foregroundColor: Theme.of(context).colorScheme.onPrimary,
                  padding: ResponsiveUtils.getResponsivePadding(
                    horizontal: 16.w,
                    vertical: 8.h,
                  ),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(8.r),
                  ),
                ),
                child: Text(
                  'ÂàõÂª∫',
                  style: TextStyle(
                    fontSize: ResponsiveUtils.getResponsiveFontSize(16.sp),
                  ),
                ),
              ),
            ],
          ),
    );
  }

  void _createFolder(String folderName) async {
    final state = ref.read(cloudDriveProvider);
    final currentAccount = state.currentAccount;

    if (currentAccount == null) {
      _showErrorMessage('ËØ∑ÂÖàÈÄâÊã©‰∫ëÁõòË¥¶Âè∑');
      return;
    }

    // Ê£ÄÊü•ÊòØÂê¶ÊîØÊåÅÂàõÂª∫Êñá‰ª∂Â§π
    if (!CloudDriveOperationService.isOperationSupported(
      currentAccount,
      'createFolder',
    )) {
      _showErrorMessage('ÂΩìÂâç‰∫ëÁõò‰∏çÊîØÊåÅÂàõÂª∫Êñá‰ª∂Â§πÂäüËÉΩ');
      return;
    }

    // Ëé∑ÂèñÂΩìÂâçÊñá‰ª∂Â§πID
    String? parentFolderId;
    if (state.folderPath.isNotEmpty) {
      parentFolderId = state.folderPath.last.id;
    }

    _logFolderCreation(folderName, parentFolderId, currentAccount);

    try {
      // ‰ΩøÁî®Áªü‰∏ÄÁöÑÊìç‰ΩúÊúçÂä°ÂàõÂª∫Êñá‰ª∂Â§π
      final result = await CloudDriveOperationService.createFolder(
        account: currentAccount,
        folderName: folderName,
        parentFolderId: parentFolderId,
      );

      await _handleCreateFolderResult(result, folderName);
    } catch (e, stackTrace) {
      _handleCreateFolderError(e, stackTrace, folderName);
    }
  }

  /// ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
  void _showErrorMessage(String message) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 2),
        ),
      );
    }
  }

  /// ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
  void _showSuccessMessage(String message) {
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(message),
          backgroundColor: CloudDriveUIConfig.successColor,
          duration: const Duration(seconds: 2),
        ),
      );
    }
  }

  /// ËÆ∞ÂΩïÊñá‰ª∂Â§πÂàõÂª∫Êó•Âøó
  void _logFolderCreation(
    String folderName,
    String? parentFolderId,
    CloudDriveAccount account,
  ) {
    LogManager().cloudDrive('üìÅ ÂºÄÂßãÂàõÂª∫Êñá‰ª∂Â§π');
    LogManager().cloudDrive('üìù Êñá‰ª∂Â§πÂêçÁß∞: $folderName');
    LogManager().cloudDrive('üìÇ Áà∂Êñá‰ª∂Â§πID: ${parentFolderId ?? 'Ê†πÁõÆÂΩï'}');
    LogManager().cloudDrive(
      'üë§ Ë¥¶Âè∑‰ø°ÊÅØ: ${account.name} (${account.type.displayName})',
    );
  }

  /// Â§ÑÁêÜÂàõÂª∫Êñá‰ª∂Â§πÁªìÊûú
  Future<void> _handleCreateFolderResult(
    Map<String, dynamic>? result,
    String folderName,
  ) async {
    if (result != null && result['success'] == true) {
      LogManager().cloudDrive('‚úÖ Êñá‰ª∂Â§πÂàõÂª∫ÊàêÂäü');

      // Â¶ÇÊûúËøîÂõûÁªìÊûú‰∏≠ÂåÖÂê´Êñá‰ª∂Â§πÂØπË±°ÔºåÁõ¥Êé•Ê∑ªÂä†Âà∞Áä∂ÊÄÅ
      if (result['folder'] != null) {
        final folder = result['folder'] as CloudDriveFile;
        LogManager().cloudDrive('üìÅ Ê∑ªÂä†Êñ∞Êñá‰ª∂Â§πÂà∞Áä∂ÊÄÅ: ${folder.name}');

        // Áõ¥Êé•Ê∑ªÂä†Êñá‰ª∂Â§πÂà∞ÂΩìÂâçÁä∂ÊÄÅ
        ref
            .read(cloudDriveProvider.notifier)
            .addFileToState(folder, operationType: 'create');
      } else {
        // ÂÖúÂ∫ïÊñπÊ°àÔºöÈáçÊñ∞Âä†ËΩΩÁõÆÂΩï
        LogManager().cloudDrive('üîÑ Êú™ËøîÂõûÊñá‰ª∂Â§πÂØπË±°ÔºåÈáçÊñ∞Âä†ËΩΩÁõÆÂΩï');
        await ref
            .read(cloudDriveProvider.notifier)
            .loadCurrentFolder(forceRefresh: true);
      }

      _showSuccessMessage('Êñá‰ª∂Â§πÂàõÂª∫ÊàêÂäü: $folderName');
    } else {
      LogManager().cloudDrive('‚ùå Êñá‰ª∂Â§πÂàõÂª∫Â§±Ë¥•');
      _showErrorMessage('Êñá‰ª∂Â§πÂàõÂª∫Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
    }
  }

  /// Â§ÑÁêÜÂàõÂª∫Êñá‰ª∂Â§πÈîôËØØ
  void _handleCreateFolderError(
    dynamic e,
    StackTrace stackTrace,
    String folderName,
  ) {
    LogManager().cloudDrive('‚ùå ÂàõÂª∫Êñá‰ª∂Â§πÂºÇÂ∏∏: $e');
    LogManager().cloudDrive('üìÑ ÈîôËØØÂ†ÜÊ†à: $stackTrace');

    _showErrorMessage('ÂàõÂª∫Êñá‰ª∂Â§πÂ§±Ë¥•: $e');
  }

  void _showAccountAddSuccess(String accountName) {
    if (context.mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Ë¥¶Âè∑Ê∑ªÂä†ÊàêÂäü: $accountName'),
          backgroundColor: CloudDriveUIConfig.successColor,
          duration: const Duration(seconds: 3),
        ),
      );
    }
  }

  void _showAccountAddError(dynamic e) {
    if (context.mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('Ë¥¶Âè∑Ê∑ªÂä†Â§±Ë¥•: $e'),
          backgroundColor: Colors.red,
          duration: const Duration(seconds: 3),
        ),
      );
    }
  }

  /// ÊûÑÂª∫ÂìçÂ∫îÂºèListTile
  Widget _buildResponsiveListTile({
    required BuildContext context,
    required IconData icon,
    required String title,
    VoidCallback? onTap,
    bool enabled = true,
  }) {
    return Container(
      margin: EdgeInsets.symmetric(vertical: 4.h),
      child: ListTile(
        leading: Icon(
          icon,
          color:
              enabled
                  ? Theme.of(context).colorScheme.primary
                  : Theme.of(
                    context,
                  ).colorScheme.onSurfaceVariant.withOpacity(0.5),
          size: ResponsiveUtils.getIconSize(24.sp),
        ),
        title: Text(
          title,
          style: Theme.of(context).textTheme.titleMedium?.copyWith(
            color:
                enabled
                    ? Theme.of(context).colorScheme.onSurface
                    : Theme.of(
                      context,
                    ).colorScheme.onSurfaceVariant.withOpacity(0.5),
            fontSize: ResponsiveUtils.getResponsiveFontSize(16.sp),
          ),
        ),
        onTap: enabled ? onTap : null,
        enabled: enabled,
        contentPadding: ResponsiveUtils.getResponsivePadding(
          horizontal: 16.w,
          vertical: 8.h,
        ),
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(ResponsiveUtils.getCardRadius()),
        ),
      ),
    );
  }
}
